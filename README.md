# Helpdesk система для ОБУЗ КГКБСМП

Система учета и обработки заявок с интеграцией Telegram-бота.

## Установка и запуск

1. Клонировать репозиторий
2. Создать и активировать виртуальное окружение:
   ```bash
   python -m venv venv
   source venv/bin/activate  # Linux/Mac
   venv\Scripts\activate     # Windows
   ```
3. Установить зависимости:
   ```bash
   pip install -r requirements.txt
   ```
4. Запустить миграцию базы данных:
   ```bash
   python run_migrations.py
   ```
5. Запустить приложение:
   ```bash
   python main.py
   ```

## Первый запуск

При первом запуске или при обновлении системы необходимо выполнить миграцию базы данных, чтобы создать все необходимые таблицы:

```bash
python run_migrations.py
```

Если при запуске возникают ошибки, связанные с отсутствием таблиц (например, `audit_logs`), выполните миграцию базы данных.

## Основные функции

### Подтверждение регистрации пользователей

В системе реализована функция подтверждения регистрации новых пользователей:

1. Новые пользователи, зарегистрированные через Telegram-бота, получают статус "неподтвержденных".
2. Кураторы и администраторы могут подтверждать или отклонять регистрации на странице "Подтверждение регистраций".
3. Неподтвержденные пользователи не могут войти в систему до подтверждения их учетной записи.
4. Уведомления о принятии или отклонении регистрации записываются в журнал аудита.

### Категории заявок

Доступ к странице "Категории" имеют только пользователи с ролью "куратор". На этой странице можно:
- Создавать новые категории заявок.
- Редактировать существующие категории.
- Отключать неиспользуемые категории.

### Учет и обработка заявок

Основные функции системы:
- Просмотр и фильтрация заявок.
- Назначение заявок на исполнителей.
- Внутренняя и внешняя коммуникация по заявкам.
- Решение заявок и фиксация результатов.
- Статистика и отчеты.

## Структура проекта

- `main.py` - основной файл запуска приложения.
- `app.py` - основной модуль Flask-приложения.
- `models/` - модели данных:
  - `user_models.py` - модели пользователей.
  - `ticket_models.py` - модели заявок и связанных сущностей.
  - `db_init.py` - инициализация базы данных.
- `templates/` - шаблоны Jinja2.
- `static/` - статические файлы (CSS, JS).
- `bot/` - модуль для Telegram-бота.
- `migrate.py` - скрипт миграции базы данных.
- `run_migrations.py` - исполняемый скрипт для запуска всех миграций.

## Миграции базы данных

Система использует SQLite в качестве СУБД. База данных разделена на два файла:
- `users.db` - база данных пользователей.
- `tickets.db` - база данных заявок, категорий и журналов аудита.

При обновлении системы могут требоваться миграции базы данных. Для запуска всех необходимых миграций используйте скрипт:

```bash
python run_migrations.py
```

## Использование административных инструментов

### Управление пользователями

```bash
# Показать всех пользователей
python admin_user_manage.py list

# Показать только неподтвержденных пользователей
python admin_user_manage.py list --pending

# Подтвердить пользователя по ID
python admin_user_manage.py confirm --id 123

# Деактивировать пользователя по chat_id
python admin_user_manage.py deactivate --chat_id 456789012

# Изменить роль пользователя
python admin_user_manage.py role --id 123 --role admin
```

### Просмотр журнала аудита

```bash
# Просмотр последних 50 записей
python view_audit_logs.py

# Фильтр по действиям с ПДн
python view_audit_logs.py --pdn_related

# Экспорт записей в CSV
python view_audit_logs.py --pdn_related --export_csv audit_export.csv

# Поиск по описанию
python view_audit_logs.py --search "регистрация"

# Фильтр по периоду
python view_audit_logs.py --date_from 2023-01-01 --date_to 2023-01-31
```

## Требования безопасности

1. Все действия с персональными данными журналируются.
2. Пользователи системы подтверждаются администратором.
3. Деактивация учетных записей без удаления истории работы.
4. Хранение согласий на обработку ПДн согласно 152-ФЗ.

## Планы по доработке

1. Перенос на PostgreSQL для повышения надёжности хранения данных.
2. Добавление двухфакторной аутентификации.
3. Интеграция с LDAP/Active Directory.
4. Автоматическое резервное копирование данных.
5. Расширение журналирования для всех действий в веб-интерфейсе.
